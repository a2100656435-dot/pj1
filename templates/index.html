<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>File Upload & Scan</title>
  </head>
  <body>
    <h2>Upload</h2>
    <!-- 给 form 添加 id -->
    <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
      <label>PIN：<input type="text" name="code" required></label><br>
      <label>File：<input type="file" name="file" required></label><br>
      <button type="submit">Submit</button>
    </form>

    <!-- 用于显示返回结果 -->
    <div id="result" style="margin-top: 20px;"></div>

    <!-- JS 异步提交 -->
    <script>
      const form = document.getElementById('uploadForm');
      const resultDiv = document.getElementById('result');

      form.addEventListener('submit', async (e) => {
        e.preventDefault(); // 阻止默认表单提交刷新页面
        const fd = new FormData(form);

        try {
          const res = await fetch('/upload', {
            method: 'POST',
            body: fd
          });
          const data = await res.json();

          if (res.ok && data.status === "success") {
            // 成功，显示 SHA 和可点击链接
            resultDiv.innerHTML = `
              <div style="color: green;">
                ✅ 提交成功！<br>
                SHA: <code>${data.sha}</code><br>
                <a href="${data.view_url}" target="_blank">查看扫描结果</a>
              </div>
            `;
          } else {
            // 错误提示
            resultDiv.innerHTML = `<div style="color: red;">⚠️ 错误：${data.message || JSON.stringify(data)}</div>`;
          }
        } catch (err) {
          resultDiv.innerHTML = `<div style="color: red;">⚠️ 网络错误：${err}</div>`;
        }
      });
    </script>
  </body>
</html>

